### API端点：历史行情查询

这个API端点用于获取单只A股股票在指定日期范围内的历史日K线数据。

#### 1. URL 格式

```
http://<你的服务器IP>:<端口号>/api/history?symbol=<股票代码>&start_date=<开始日期>&end_date=<结束日期>
```

#### 2. 请求方法

*   **GET**

#### 3. 参数说明

| 参数名 | 是否必须 | 示例 | 描述 |
| :--- | :--- | :--- | :--- |
| `symbol` | **是** | `sh600519` | 完整的股票代码，需要包含 `sh` (上海) 或 `sz` (深圳) 前缀。 |
| `start_date` | 否 | `20240101` | 查询的开始日期，格式为 `YYYYMMDD`。如果省略，默认从最近可用交易日往前追溯 1 年。 |
| `end_date` | 否 | `20240131` | 查询的结束日期，格式为 `YYYYMMDD`。如果省略，默认使用最近一个已经收盘的交易日。 |

---

#### 4. 使用示例

**示例1：查询贵州茅台 (sh600519) 在2024年1月份的全部历史行情**

```bash
curl "http://74.226.178.107:57777/api/history?symbol=sh600519&start_date=20240101&end_date=20240131"
```

**示例2：查询比亚迪 (sz002594) 从2023年1月1日至今的全部历史行情 (省略结束日期)**

```bash
curl "http://74.226.178.107:57777/api/history?symbol=sz002594&start_date=20230101"
```

**示例3：查询宁德时代 (sz300750) 从默认开始日期 (20200101) 到今天的全部历史行情 (省略所有日期参数)**

```bash
curl "http://74.226.178.107:57777/api/history?symbol=sz300750"
```

---

#### 5. 返回结果说明

##### 成功响应

*   **HTTP 状态码**: `200 OK`
*   **JSON 结构**:
    ```json
    {
        "status": "success",
        "symbol": "sh600519", // 你请求的原始股票代码
        "data": [
            {
                "日期": "2024-01-02",
                "开盘": 1632.64,
                "收盘": 1602.65,
                "最高": 1635.83,
                "最低": 1595.74,
                "成交量": 32156,
                "成交额": 5440082548.0,
                "振幅": 2.44,
                "涨跌幅": -2.49,
                "涨跌额": -40.99,
                "换手率": 0.26
            },
            {
                // ... 第二天的数据 ...
            },
            // ... 更多日期的数据 ...
        ]
    }
    ```
    `data` 是一个数组，其中每个对象代表一个交易日的所有行情数据。数据是按日期升序排列的。

##### 失败响应

*   **HTTP 状态码**: `400 Bad Request` (参数错误) 或 `500 Internal Server Error` (服务器内部错误)
*   **JSON 结构**:
    ```json
    {
        "status": "error",
        "message": "具体的错误信息描述"
    }
    ```
    **常见错误信息包括：**
    *   `必须提供 'symbol' 参数。` (当URL中缺少 `symbol` 时)
    *   `ak.stock_zh_a_hist 未返回有效数据。请检查代码 '...' 和日期范围是否正确。` (当股票代码不存在，或该代码在该日期范围内停牌/未上市时)

---

#### 6. 客户端缓存与增量更新策略

为了减少重复请求并提升性能，客户端在首次请求时会拉取过去一整年的日线数据，并将结果缓存在本地（按股票代码分文件存储）。之后的行为如下：

1. **增量补数**：
    * 当请求的时间范围早于缓存的起始日期时，会自动向前补齐缺口部分；
    * 当请求的结束日期晚于缓存的结束日期时，仅向后增量补充缺失的交易日；
    * 缓存会自动排序并去重，保证每个交易日只保留一份数据。

2. **交易日判断**：
    * 默认只向后请求到最近一个已经收盘的交易日；
    * 周末、节假日等非交易日不会触发远端请求，客户端会直接使用实时行情作为最新的展示点。

3. **实时点拼接**：
    * 历史曲线的最后一个数据点使用真实行情的昨日日线收盘价；
    * 当前自然日の实时估值会通过快照行情计算后追加在曲线末尾，确保净值曲线在交易时段内也能实时更新。

4. **缓存持久化**：
    * 缓存位于应用数据目录；
    * 支持按股票或全部清除缓存，同时提供缓存统计信息（数量、大小、覆盖范围等）。

> ⚠️ 提示：如果你需要强制刷新某只股票的数据，可以调用 `MarketDataService.clearSymbolCache(symbol)` 删除对应缓存文件，随后重新发起请求即可重新拉取最新的完整历史数据。
