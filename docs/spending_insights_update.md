# 支出洞察功能更新

## 更新日期

2025年10月1日

## 更新内容

### 1. 新增六个月收支柱状图

在支出洞察详情页面添加了近六个月的收支对比柱状图，帮助用户更直观地了解财务趋势。

**位置：** 放置在支出类别分布饼图后面

**特性：**

- 展示最近6个月的收入和支出数据
- 使用绿色柱表示收入，红色柱表示支出
- 如果某月没有数据，会显示为空柱（值为0）
- 自动适配月份标签格式（年/月）

### 2. 每日平均支出显示

在每日支出轨迹图表的副标题中直接显示每日平均支出金额。

**显示位置：** 每日支出轨迹图表的副标题

**计算方式：**

```text
每日平均支出 = 近30天总支出 / 统计天数
```

**显示格式：**

- 数据充足时：`覆盖最近 N 天消费走势，每日平均支出 ¥XX.XX`
- 数据不足时：显示原有提示信息

## UI布局顺序

支出洞察详情页面的最新布局：

1. 支出摘要卡片（原有）
2. 每日支出轨迹图表（原有，副标题增加平均支出显示）
3. 类别明细（原有）
4. 支出类别分布饼图（原有）
5. **近六个月收支对比柱状图**（新增）
6. 提示与建议（原有）

## 修改的文件

### 1. 新增文件

#### `lib/features/analytics/widgets/analytics_bar_chart.dart`

- 新建的柱状图组件
- 支持月度收支数据可视化
- 包含：
  - `MonthlyBarData` - 月度数据模型
  - `AnalyticsBarChart` - 主要柱状图组件
  - `_BarChartPainter` - 自定义绘制逻辑

### 2. 修改文件

#### `lib/features/analytics/models/analytics_models.dart`

**添加：**

- `MonthlyIncomeExpense` 类：存储月度收支数据
  - `month`: 月份（DateTime）
  - `income`: 收入金额
  - `expense`: 支出金额

**修改：**

- `SpendingAnalyticsOverview` 类：添加 `monthlySummary` 字段
  - 类型：`List<MonthlyIncomeExpense>`
  - 包含最近6个月的收支统计

#### `lib/services/analytics_service.dart`

**修改：**

- `_buildSpendingOverview()` 方法：
  - 添加月度统计逻辑
  - 计算近6个月的收入和支出
  - 按月归类所有交易
  - 生成完整的6个月数据（包括空月份）

**核心逻辑：**

```dart
// 计算近6个月的收支统计
final sixMonthsAgo = DateTime(now.year, now.month - 5, 1);

// 按月分组所有交易
for (final txn in transactions.where((t) => !t.date.isBefore(sixMonthsAgo))) {
  final month = normalizeMonth(txn.date);
  // 累加收入和支出...
}

// 生成最近6个月的数据
for (var i = 5; i >= 0; i--) {
  final month = DateTime(now.year, now.month - i, 1);
  // 添加到 monthlySummary...
}
```

#### `lib/features/analytics/views/spending_detail_view.dart`

**添加：**

1. 导入新的柱状图组件：
   ```dart
   import '../widgets/analytics_bar_chart.dart';
   ```

2. 在副标题中显示每日平均支出：
   ```dart
   final subtitle = switch (coverageDays) {
     0 => '暂无可视化数据，先记一笔消费吧。',
     1 => '仅包含最近 1 天消费，已自动拉伸展示。',
     _ => '覆盖最近 $coverageDays 天消费走势，每日平均支出 ${_formatCurrency(dailyAverage)}',
   };
   ```

3. 调整UI布局顺序，将柱状图放在饼图后面

**移除：**

- `_DailyAverageCard` 组件（改为在图表副标题中显示）

## 数据处理细节

### 月度统计逻辑

1. 获取所有交易记录
2. 筛选最近6个月的交易
3. 按月份归类：
   - 收入交易累加到 `income`
   - 支出交易累加到 `expense`
4. 生成完整6个月数据：
   - 即使某月没有交易也会生成记录（金额为0）
   - 确保图表完整性

### 每日平均计算

- 只在有数据时显示（`coverageDays > 0`）
- 使用近30天的总支出除以实际天数
- 格式化显示（支持万、亿单位）
- 直接集成到图表副标题中，更简洁

## 用户体验改进

1. **更完整的财务视图**：通过月度柱状图，用户可以看到更长时间范围的收支趋势

2. **空数据处理**：如果某月没有数据，显示为空柱而不是隐藏，保持时间轴的连续性

3. **简洁的日均开销显示**：每日平均支出直接集成在图表副标题中，不占用额外空间，信息获取更直观

4. **合理的信息层级**：将月度统计放在饼图后面，从短期趋势（每日）到中期总览（类别分布）再到长期趋势（月度对比），信息展示更有层次

5. **视觉一致性**：所有新增组件都遵循应用的 Cupertino 设计规范

## 技术特点

1. **响应式设计**：使用 CustomPainter 实现自适应的柱状图绘制
2. **颜色语义化**：绿色代表收入，红色代表支出，符合用户直觉
3. **数据完整性**：确保即使缺少数据也能正常显示
4. **性能优化**：使用高效的数据结构和绘制逻辑
5. **简化UI**：每日平均支出不再需要单独卡片，减少页面元素

## 测试建议

1. 测试不同数据场景：
   - 完整6个月数据
   - 部分月份有数据
   - 只有最近1-2个月的数据
   - 某些月份只有收入或只有支出

2. 验证计算准确性：
   - 检查月度统计总和
   - 验证每日平均计算
   - 确认日期范围正确

3. UI测试：
   - 不同屏幕尺寸的显示效果
   - 明暗模式切换
   - 长数字的显示格式
   - 副标题中平均支出的可读性

## 未来改进方向

1. 添加月度同比/环比分析
2. 支持自定义统计周期
3. 添加趋势预测功能
4. 支持导出报表
5. 增加更多洞察指标（如储蓄率、支出增长率等）
